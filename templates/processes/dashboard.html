{% extends 'base.html' %}

{% block title %}Dashboard - {{ cervejaria.name }}{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h2>Dashboard - AnÃ¡lise de Performance</h2>
        <p style="color: #999; margin-top: 0.5rem;">{{ cervejaria.name }} | Ãšltima atualizaÃ§Ã£o: Agora</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="{% url 'brewery:detail' cervejaria.id %}" class="btn btn-secondary">â† Voltar</a>
        <a href="{% url 'process:dre' cervejaria.id %}" class="btn btn-success">ğŸ“Š Ver DRE</a>
    </div>
</div>

<div class="content">
    <!-- ===== SEÃ‡ÃƒO 1: KPIs PRINCIPAIS ===== -->
    <div style="margin-bottom: 2.5rem;">
        <h3 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 0.5rem;">ğŸ“Š Resumo Geral</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
            <div class="card" style="border-left: 5px solid #3498db; background: linear-gradient(135deg, #ecf0f1 0%, #ffffff 100%);">
                <h3 style="margin: 0 0 0.5rem 0; color: #3498db; display: flex; align-items: center; gap: 0.5rem;">ğŸ“‹ Processos</h3>
                <p style="font-size: 2.5rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ total_processos }}</p>
                <p style="color: #666; margin: 0; font-size: 0.9rem;">SOPs cadastrados e ativos</p>
            </div>

            <div class="card" style="border-left: 5px solid #28a745; background: linear-gradient(135deg, #eafce8 0%, #ffffff 100%);">
                <h3 style="margin: 0 0 0.5rem 0; color: #28a745; display: flex; align-items: center; gap: 0.5rem;">â–¶ï¸ ExecuÃ§Ãµes</h3>
                <p style="font-size: 2.5rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ total_execucoes }}</p>
                <small style="color: #666;">âœ“ {{ execucoes_concluidas }} concluÃ­das</small>
            </div>

            <div class="card" style="border-left: 5px solid #9b59b6; background: linear-gradient(135deg, #f4ecf7 0%, #ffffff 100%);">
                <h3 style="margin: 0 0 0.5rem 0; color: #9b59b6; display: flex; align-items: center; gap: 0.5rem;">ğŸ“ˆ Taxa Conformidade</h3>
                <p style="font-size: 2.5rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ taxa_conformidade_geral|floatformat:1 }}%</p>
                <small style="color: #666;">Processos sem nÃ£o-conformidades ativas</small>
            </div>

            <div class="card" style="border-left: 5px solid #3498db; background: linear-gradient(135deg, #eef5fb 0%, #ffffff 100%);">
                <h3 style="margin: 0 0 0.5rem 0; color: #3498db; display: flex; align-items: center; gap: 0.5rem;">âœ“ HACCP Conformidade</h3>
                <p style="font-size: 2.5rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ taxa_conformidade_haccp|floatformat:1 }}%</p>
                <small style="color: #666;">{{ total_registros_haccp }} registros | âš ï¸ {{ registros_nao_conformes }} desvios</small>
            </div>
        </div>
    </div>

    <!-- ===== SEÃ‡ÃƒO 1.5: GRÃFICOS INTERATIVOS PLOTLY ===== -->
    <!-- ===== SEÃ‡ÃƒO 1.5: GRÃFICOS INTERATIVOS ===== -->
    <div style="margin-bottom: 2.5rem;">
        <h3 style="color: #2c3e50; border-bottom: 3px solid #9b59b6; padding-bottom: 0.5rem;">ğŸ“Š GrÃ¡ficos AnalÃ­ticos</h3>
        
        <div style="background: #f0f8ff; padding: 2rem; border-radius: 8px; text-align: center; border: 2px dashed #3498db;">
            <p style="color: #2c3e50; font-size: 1.1rem; margin: 0;">
                ğŸ“ˆ GrÃ¡ficos interativos em desenvolvimento
            </p>
            <p style="color: #7f8c8d; font-size: 0.95rem; margin: 0.5rem 0 0 0;">
                Os grÃ¡ficos com dados analÃ­ticos estarÃ£o disponÃ­veis em breve
            </p>
        </div>
    </div>

    <!-- ===== SEÃ‡ÃƒO 2: ANÃLISE DE TENDÃŠNCIAS NC ===== -->
    <div style="margin-bottom: 2.5rem; background: #fefaf0; padding: 1.5rem; border-radius: 8px; border-left: 5px solid #ff9800;">
        <h3 style="color: #e67e22; margin-top: 0;">ğŸ“‰ AnÃ¡lise de TendÃªncia - NÃ£o Conformidades</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
            <div class="card">
                <h4 style="margin: 0 0 1rem 0; color: #ff9800;">Ãšltimos 7 dias</h4>
                <p style="font-size: 2rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ ncs_7_dias }}</p>
                <p style="color: #666; margin: 0; font-size: 0.9rem;">NCs criadas</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 1rem 0; color: #ff9800;">Dias 7-14</h4>
                <p style="font-size: 2rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ ncs_14_dias }}</p>
                <p style="color: #666; margin: 0; font-size: 0.9rem;">NCs criadas</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 1rem 0; color: #ff9800;">Dias 14-30</h4>
                <p style="font-size: 2rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ ncs_30_dias }}</p>
                <p style="color: #666; margin: 0; font-size: 0.9rem;">NCs criadas</p>
            </div>

            <div class="card" style="border: 2px solid #ff9800; background: {% if tendencia_nc == 'crescente' %}#ffe8d6{% elif tendencia_nc == 'decrescente' %}#d4edda{% else %}#f0f0f0{% endif %};">
                <h4 style="margin: 0 0 1rem 0; color: #ff9800;">ğŸ“Š TendÃªncia</h4>
                <p style="font-size: 2rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">
                    {% if tendencia_nc == 'crescente' %}
                        â¬†ï¸ Crescente
                    {% elif tendencia_nc == 'decrescente' %}
                        â¬‡ï¸ Decrescente
                    {% else %}
                        â¡ï¸ EstÃ¡vel
                    {% endif %}
                </p>
                <p style="color: #666; margin: 0; font-size: 0.85rem;">
                    {% if tendencia_nc == 'crescente' %}
                        <span style="color: #dc3545;"><strong>âš ï¸ AtenÃ§Ã£o:</strong> NCs aumentando</span>
                    {% elif tendencia_nc == 'decrescente' %}
                        <span style="color: #28a745;"><strong>âœ“ Bom:</strong> NCs diminuindo</span>
                    {% else %}
                        <span style="color: #666;"><strong>â„¹ï¸</strong> NCs estÃ¡veis</span>
                    {% endif %}
                </p>
            </div>
        </div>

        <div style="margin-top: 1.5rem;">
            <h4>DistribuiÃ§Ã£o por Severidade:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div style="background: #dc3545; color: white; padding: 1rem; border-radius: 4px; text-align: center;">
                    <p style="margin: 0; font-size: 1.8rem; font-weight: bold;">{{ ncs_critica }}</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">ğŸ”´ CrÃ­ticas</p>
                </div>
                <div style="background: #ff9800; color: white; padding: 1rem; border-radius: 4px; text-align: center;">
                    <p style="margin: 0; font-size: 1.8rem; font-weight: bold;">{{ ncs_alta }}</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">ğŸŸ  Altas</p>
                </div>
                <div style="background: #ffc107; color: #333; padding: 1rem; border-radius: 4px; text-align: center;">
                    <p style="margin: 0; font-size: 1.8rem; font-weight: bold;">{{ ncs_media }}</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">ğŸŸ¡ MÃ©dias</p>
                </div>
                <div style="background: #28a745; color: white; padding: 1rem; border-radius: 4px; text-align: center;">
                    <p style="margin: 0; font-size: 1.8rem; font-weight: bold;">{{ ncs_baixa }}</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">ğŸŸ¢ Baixas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SEÃ‡ÃƒO 3: ANÃLISE DE TENDÃŠNCIAS HACCP ===== -->
    <div style="margin-bottom: 2.5rem; background: #f0f8ff; padding: 1.5rem; border-radius: 8px; border-left: 5px solid #3498db;">
        <h3 style="color: #2980b9; margin-top: 0;">ğŸ“Š AnÃ¡lise de TendÃªncia - Monitoramento HACCP</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
            <div class="card">
                <h4 style="margin: 0 0 1rem 0; color: #3498db;">Ãšltimos 7 dias</h4>
                <p style="font-size: 2rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ desvios_7_dias }}</p>
                <p style="color: #666; margin: 0; font-size: 0.9rem;">Registros fora de conformidade</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 1rem 0; color: #3498db;">Dias 7-14</h4>
                <p style="font-size: 2rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ desvios_14_dias }}</p>
                <p style="color: #666; margin: 0; font-size: 0.9rem;">Registros fora de conformidade</p>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 1rem 0; color: #3498db;">Dias 14-30</h4>
                <p style="font-size: 2rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ desvios_30_dias }}</p>
                <p style="color: #666; margin: 0; font-size: 0.9rem;">Registros fora de conformidade</p>
            </div>

            <div class="card" style="border: 2px solid #3498db; background: {% if tendencia_haccp == 'piorando' %}#ffe8d6{% elif tendencia_haccp == 'melhorando' %}#d4edda{% else %}#f0f0f0{% endif %};">
                <h4 style="margin: 0 0 1rem 0; color: #3498db;">ğŸ“ˆ TendÃªncia</h4>
                <p style="font-size: 2rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">
                    {% if tendencia_haccp == 'piorando' %}
                        â¬†ï¸ Piorando
                    {% elif tendencia_haccp == 'melhorando' %}
                        â¬‡ï¸ Melhorando
                    {% else %}
                        â¡ï¸ EstÃ¡vel
                    {% endif %}
                </p>
                <p style="color: #666; margin: 0; font-size: 0.85rem;">
                    {% if tendencia_haccp == 'piorando' %}
                        <span style="color: #dc3545;"><strong>âš ï¸ CrÃ­tico:</strong> Desvios aumentando</span>
                    {% elif tendencia_haccp == 'melhorando' %}
                        <span style="color: #28a745;"><strong>âœ“ Excelente:</strong> Controle melhorando</span>
                    {% else %}
                        <span style="color: #666;"><strong>â„¹ï¸</strong> Desvios estÃ¡veis</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- ===== SEÃ‡ÃƒO 4: STATUS GERAL ===== -->
    <div style="margin-bottom: 2.5rem;">
        <h3 style="color: #2c3e50; border-bottom: 3px solid #e74c3c; padding-bottom: 0.5rem;">âš¡ Status Atual</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
            <div class="card" style="border-left: 5px solid #e74c3c; background: #fadbd8;">
                <h4 style="margin: 0 0 0.5rem 0; color: #e74c3c; display: flex; align-items: center; gap: 0.5rem;">âš ï¸ NCs Ativas</h4>
                <p style="font-size: 2.5rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ ncs_ativas }}</p>
                <small style="color: #666;">
                    {% if ncs_criticas_ativas > 0 %}
                        ğŸ”´ {{ ncs_criticas_ativas }} crÃ­ticas - AÃ‡ÃƒO IMEDIATA!
                    {% else %}
                        âœ“ Sem crÃ­ticas
                    {% endif %}
                </small>
            </div>

            <div class="card" style="border-left: 5px solid #f39c12; background: #fef5e7;">
                <h4 style="margin: 0 0 0.5rem 0; color: #f39c12; display: flex; align-items: center; gap: 0.5rem;">ğŸ”§ CAPAs Pendentes</h4>
                <p style="font-size: 2.5rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">{{ capas_pendentes }}</p>
                <small style="color: #666;">âœ“ {{ capas_concluidas }} concluÃ­das</small>
            </div>

            <div class="card" style="border-left: 5px solid #27ae60; background: #d5f4e6;">
                <h4 style="margin: 0 0 0.5rem 0; color: #27ae60; display: flex; align-items: center; gap: 0.5rem;">ğŸ† Performance</h4>
                <p style="font-size: 2.5rem; margin: 1rem 0 0.5rem 0; font-weight: bold;">
                    {% if taxa_conformidade_geral > 90 %}
                        A+
                    {% elif taxa_conformidade_geral > 80 %}
                        A
                    {% elif taxa_conformidade_geral > 70 %}
                        B+
                    {% else %}
                        C
                    {% endif %}
                </p>
                <small style="color: #666;">Sistema com {{ taxa_conformidade_geral|floatformat:0 }}% de conformidade</small>
            </div>
        </div>
    </div>

    <!-- ===== SEÃ‡ÃƒO 5: NCs NÃƒO RESOLVIDAS ===== -->
    {% if ncs_antigas %}
    <div style="margin-bottom: 2.5rem;">
        <h3 style="color: #c0392b; border-bottom: 3px solid #c0392b; padding-bottom: 0.5rem;">ğŸš¨ NCs Pendentes hÃ¡ Mais Tempo</h3>
        <div style="margin-top: 1rem;">
            {% for nc in ncs_antigas %}
            <div class="card" style="margin-bottom: 1rem; border-left: 4px solid {% if nc.severidade == 'critica' %}#dc3545{% elif nc.severidade == 'alta' %}#ff9800{% elif nc.severidade == 'media' %}#ffc107{% else %}#28a745{% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0;">NC-{{ nc.id }}: {{ nc.titulo }}</h4>
                        <p style="color: #666; margin: 0 0 0.5rem 0; font-size: 0.9rem;">{{ nc.descricao|truncatewords:20 }}</p>
                        <small style="color: #999;">Criada: {{ nc.data_criacao|date:"d/m/Y H:i" }} (hÃ¡ {{ nc.data_criacao|timesince }})</small>
                    </div>
                    <a href="{% url 'process:detalhe_nc' cervejaria.id nc.id %}" class="btn btn-sm btn-primary" style="white-space: nowrap;">Ver Detalhes</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ===== SEÃ‡ÃƒO 6: ÃšLTIMAS ATIVIDADES ===== -->
    <div style="margin-bottom: 2.5rem;">
        <h3 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 0.5rem;">ğŸ“‹ Ãšltimas NÃ£o Conformidades</h3>
        {% if ultimas_ncs %}
            <table class="table" style="margin-top: 1rem;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>TÃ­tulo</th>
                        <th>Severidade</th>
                        <th>Status</th>
                        <th>Criada em</th>
                        <th>AÃ§Ã£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nc in ultimas_ncs %}
                    <tr>
                        <td><strong>NC-{{ nc.id }}</strong></td>
                        <td>{{ nc.titulo|truncatewords:5 }}</td>
                        <td>
                            {% if nc.severidade == 'critica' %}
                                <span class="badge" style="background: #dc3545; color: white; padding: 0.5rem 1rem;">ğŸ”´ CrÃ­tica</span>
                            {% elif nc.severidade == 'alta' %}
                                <span class="badge" style="background: #ff9800; color: white; padding: 0.5rem 1rem;">ğŸŸ  Alta</span>
                            {% elif nc.severidade == 'media' %}
                                <span class="badge" style="background: #ffc107; color: #333; padding: 0.5rem 1rem;">ğŸŸ¡ MÃ©dia</span>
                            {% else %}
                                <span class="badge" style="background: #28a745; color: white; padding: 0.5rem 1rem;">ğŸŸ¢ Baixa</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if nc.status == 'aberta' %}
                                <span style="color: #dc3545; font-weight: bold;">ğŸ”´ Aberta</span>
                            {% elif nc.status == 'em_analise' %}
                                <span style="color: #ff9800; font-weight: bold;">ğŸŸ  Em AnÃ¡lise</span>
                            {% elif nc.status == 'em_correcao' %}
                                <span style="color: #ffc107; font-weight: bold;">ğŸŸ¡ Em CorreÃ§Ã£o</span>
                            {% else %}
                                <span style="color: #28a745; font-weight: bold;">âœ“ Fechada</span>
                            {% endif %}
                        </td>
                        <td>{{ nc.data_criacao|date:"d/m/Y" }}</td>
                        <td>
                            <a href="{% url 'process:detalhe_nc' cervejaria.id nc.id %}" style="color: #3498db; text-decoration: none; font-weight: bold;">â†’</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="card" style="text-align: center; padding: 2rem; background: #d4edda; border: 2px solid #28a745;">
                <p style="color: #155724; margin: 0; font-size: 1.1rem;">âœ“ Nenhuma nÃ£o conformidade registrada!</p>
            </div>
        {% endif %}
    </div>

    <!-- Links rÃ¡pidos -->
    <div style="margin-top: 2rem; background: #ecf0f1; padding: 1.5rem; border-radius: 8px;">
        <h3 style="margin-top: 0; color: #2c3e50;">âš¡ AÃ§Ãµes RÃ¡pidas</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
            <a href="{% url 'process:nao_conformidades' cervejaria.id %}" class="btn btn-secondary" style="text-align: center; padding: 1rem;">ğŸ“‹ Gerenciar NCs</a>
            <a href="{% url 'process:pontos_criticos_cervejaria' cervejaria.id %}" class="btn btn-secondary" style="text-align: center; padding: 1rem;">ğŸ¯ Pontos HACCP</a>
            <a href="{% url 'process:dre' cervejaria.id %}" class="btn btn-secondary" style="text-align: center; padding: 1rem;">ğŸ“Š Ver RelatÃ³rio DRE</a>
            <a href="{% url 'brewery:detail' cervejaria.id %}" class="btn btn-secondary" style="text-align: center; padding: 1rem;">â† Voltar para Cervejaria</a>
        </div>
    </div>
</div>
{% endblock %}
